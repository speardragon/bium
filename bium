#!/bin/bash

# =============================================================================
# Bium - Quick Start Script
# =============================================================================
# Usage:
#   ./bium.sh start   - Pull latest image and start Bium
#   ./bium.sh stop    - Stop Bium
#   ./bium.sh restart - Restart Bium with latest image
#   ./bium.sh status  - Check Bium status
#   ./bium.sh logs    - Show Bium logs
#   ./bium.sh update  - Update to latest version (same as restart)
# =============================================================================

set -e

# Configuration
CONTAINER_NAME="bium"
IMAGE_NAME="speardragon/bium:latest"
PORT="80"
DATA_VOLUME="bium-data"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Print banner
print_banner() {
    echo -e "${CYAN}"
    echo "  ____  _                 "
    echo " | __ )(_)_   _ _ __ ___  "
    echo " |  _ \| | | | | '_ \` _ \ "
    echo " | |_) | | |_| | | | | | |"
    echo " |____/|_|\__,_|_| |_| |_|"
    echo -e "${NC}"
    echo -e "${YELLOW}비워야 채운다 - Queue-based Time Blocking${NC}"
    echo ""
}

# Print colored message
print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if Docker is running
check_docker() {
    if ! docker info > /dev/null 2>&1; then
        print_error "Docker is not running. Please start Docker first."
        exit 1
    fi
}

# Get current image digest
get_current_digest() {
    docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE_NAME" 2>/dev/null | cut -d'@' -f2 || echo ""
}

# Pull latest image and check for updates
pull_image() {
    print_info "Checking for updates..."
    
    local old_digest=$(get_current_digest)
    
    # Pull the latest image
    docker pull "$IMAGE_NAME" 2>&1 | while read line; do
        if [[ "$line" == *"Pulling"* ]] || [[ "$line" == *"Downloading"* ]] || [[ "$line" == *"Extracting"* ]]; then
            echo -e "  ${CYAN}$line${NC}"
        elif [[ "$line" == *"up to date"* ]]; then
            echo -e "  ${GREEN}$line${NC}"
        elif [[ "$line" == *"Downloaded"* ]] || [[ "$line" == *"Pull complete"* ]]; then
            echo -e "  ${GREEN}$line${NC}"
        else
            echo "  $line"
        fi
    done
    
    local new_digest=$(get_current_digest)
    
    if [ -n "$old_digest" ] && [ "$old_digest" != "$new_digest" ]; then
        echo ""
        echo -e "${GREEN}┌─────────────────────────────────────────────────┐${NC}"
        echo -e "${GREEN}│  ✨ NEW VERSION AVAILABLE AND DOWNLOADED!       │${NC}"
        echo -e "${GREEN}│     Bium has been updated to the latest version │${NC}"
        echo -e "${GREEN}└─────────────────────────────────────────────────┘${NC}"
        echo ""
        return 0
    elif [ -z "$old_digest" ]; then
        print_success "Image downloaded successfully!"
        return 0
    else
        print_info "Already running the latest version."
        return 1
    fi
}

# Stop and remove existing container
stop_container() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        print_info "Stopping $CONTAINER_NAME..."
        docker stop "$CONTAINER_NAME" > /dev/null 2>&1
    fi
    
    if docker ps -aq -f name="$CONTAINER_NAME" | grep -q .; then
        print_info "Removing old container..."
        docker rm "$CONTAINER_NAME" > /dev/null 2>&1
    fi
}

# Start container
start_container() {
    print_info "Starting $CONTAINER_NAME..."
    
    docker run -d \
        -p "$PORT:80" \
        -v "$DATA_VOLUME:/app/data" \
        --name "$CONTAINER_NAME" \
        --restart unless-stopped \
        "$IMAGE_NAME" > /dev/null
    
    # Wait for container to be healthy
    print_info "Waiting for Bium to be ready..."
    local max_attempts=30
    local attempt=0
    
    while [ $attempt -lt $max_attempts ]; do
        if curl -s "http://localhost:$PORT/health" > /dev/null 2>&1; then
            break
        fi
        sleep 1
        attempt=$((attempt + 1))
        echo -n "."
    done
    echo ""
    
    if [ $attempt -eq $max_attempts ]; then
        print_warning "Container started but health check timed out."
    fi
}

# Show container status
show_status() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        print_success "Bium is running!"
        echo ""
        echo -e "  ${CYAN}URL:${NC}        http://localhost:$PORT"
        echo -e "  ${CYAN}Container:${NC}  $CONTAINER_NAME"
        echo -e "  ${CYAN}Image:${NC}      $IMAGE_NAME"
        echo -e "  ${CYAN}Data:${NC}       $DATA_VOLUME"
        echo ""
        
        # Show container stats
        local stats=$(docker stats --no-stream --format "CPU: {{.CPUPerc}} | Memory: {{.MemUsage}}" "$CONTAINER_NAME" 2>/dev/null)
        if [ -n "$stats" ]; then
            echo -e "  ${CYAN}Stats:${NC}      $stats"
        fi
    else
        print_warning "Bium is not running."
        echo ""
        echo -e "  Run ${GREEN}./bium.sh start${NC} to start Bium."
    fi
}

# Main commands
cmd_start() {
    print_banner
    check_docker
    
    # Check if already running
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        print_warning "Bium is already running."
        echo ""
        echo -e "  Use ${GREEN}./bium.sh restart${NC} to restart with latest version."
        echo -e "  Use ${GREEN}./bium.sh stop${NC} to stop."
        echo ""
        show_status
        exit 0
    fi
    
    pull_image
    start_container
    
    print_success "Bium started successfully!"
    echo ""
    show_status
}

cmd_stop() {
    print_banner
    check_docker
    
    if ! docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        print_warning "Bium is not running."
        exit 0
    fi
    
    stop_container
    print_success "Bium stopped."
}

cmd_restart() {
    print_banner
    check_docker
    
    local was_running=false
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        was_running=true
    fi
    
    pull_image
    local updated=$?
    
    stop_container
    start_container
    
    if [ $updated -eq 0 ] && [ "$was_running" = true ]; then
        print_success "Bium restarted with the latest version!"
    else
        print_success "Bium restarted!"
    fi
    echo ""
    show_status
}

cmd_status() {
    print_banner
    check_docker
    show_status
}

cmd_logs() {
    check_docker
    
    if ! docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        print_error "Bium is not running."
        exit 1
    fi
    
    echo -e "${CYAN}[Bium Logs]${NC} Press Ctrl+C to exit"
    echo ""
    docker logs -f "$CONTAINER_NAME"
}

cmd_update() {
    cmd_restart
}

cmd_help() {
    print_banner
    echo "Usage: ./bium.sh <command>"
    echo ""
    echo "Commands:"
    echo -e "  ${GREEN}start${NC}     Pull latest image and start Bium"
    echo -e "  ${GREEN}stop${NC}      Stop Bium"
    echo -e "  ${GREEN}restart${NC}   Restart Bium with latest image"
    echo -e "  ${GREEN}update${NC}    Same as restart"
    echo -e "  ${GREEN}status${NC}    Check Bium status"
    echo -e "  ${GREEN}logs${NC}      Show Bium logs (follow mode)"
    echo -e "  ${GREEN}help${NC}      Show this help message"
    echo ""
}

# Main entry point
case "${1:-}" in
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    restart)
        cmd_restart
        ;;
    update)
        cmd_update
        ;;
    status)
        cmd_status
        ;;
    logs)
        cmd_logs
        ;;
    help|--help|-h)
        cmd_help
        ;;
    "")
        cmd_help
        ;;
    *)
        print_error "Unknown command: $1"
        echo ""
        cmd_help
        exit 1
        ;;
esac
